<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°€ì¹˜ê´€ ê²€ì‚¬</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      padding: 16px;
      max-width: 900px;
      margin: auto;
      background-color: #f7fbff;
    }
    h2 {
      color: #0050a0;
      text-align: center;
    }
    .question {
      margin-bottom: 24px;
      padding: 12px;
      border-bottom: 1px solid #ccc;
      font-size: 18px;
    }
    .btn-choice {
      display: inline-block;
      margin-right: 10px;
      padding: 12px 24px;
      font-size: 16px;
      background-color: #f0f0f0;
      border: 1px solid #bbb;
      border-radius: 6px;
      cursor: pointer;
      color: black;
    }
    .btn-choice.selected {
      background-color: #007BFF;
      color: white;
      border-color: #007BFF;
    }
    input[type="text"], button {
      font-size: 18px;
      padding: 10px;
    }
    button {
      background-color: #2d7ff9;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #115fd3;
    }
    .warning {
      background-color: #ffdddd;
      color: #a00;
      padding: 12px;
      border: 1px solid #a00;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
    .btn-submit {
      display: block;
      width: 100%;
      font-size: 20px;
      padding: 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      margin: 30px 0 10px;
    }
    .btn-submit:hover {
      background-color: #218838;
    }
    .loading {
      text-align: center;
      font-size: 18px;
      color: #555;
      padding: 20px;
    }
    @media (max-width: 600px) {
      .btn-choice {
        padding: 14px 18px;
        font-size: 18px;
        display: block;
        width: 100%;
        margin-bottom: 10px;
      }
      input[type="text"], button {
        width: 100%;
      }
    }
  </style>
</head>

<body>
<h2>ê°€ì¹˜ê´€ ê²€ì‚¬</h2>

<!-- ê²€ì‚¬ ì„¤ëª… ë°•ìŠ¤ -->
<div style="background-color: #f0f8ff; border-left: 6px solid #007BFF; padding: 16px; margin-bottom: 20px; border-radius: 8px;">
  <strong style="font-size: 18px; color: #0050a0;">ğŸ’¡ ê°€ì¹˜ê´€ ê²€ì‚¬ë€?</strong><br>
  ê°œì¸ì´ ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ” <strong>12ê°€ì§€ ì§ì—… ê°€ì¹˜ìœ í˜•</strong>ì„ ì§„ë‹¨í•˜ì—¬,<br>
  ìœ í˜•ë³„ ì ìˆ˜, í‰ê°€, ìê¸°ê°œë°œ íŒ, ì„±ì¥ íŒ, ê°•ì , ì•½ì ì„ ì œê³µí•©ë‹ˆë‹¤.<br>
  ê²°ê³¼ëŠ” <strong style="color: #0050a0;">ë ˆì´ë” ì°¨íŠ¸</strong> ë° <strong style="color: #0050a0;">ë§‰ëŒ€ê·¸ë˜í”„</strong>ë¡œ ì‹œê°í™”ë©ë‹ˆë‹¤.
</div>

<div style="background-color: #f8f9fa; border-left: 6px solid #6c757d; padding: 16px; margin-bottom: 30px; border-radius: 8px;">
  <strong style="font-size: 16px; color: #333;">ğŸ” ê²€ì‚¬ ìœ ì˜ì‚¬í•­</strong><br>
  - ë³¸ ê²€ì‚¬ëŠ” ìœ íš¨í•œ ê²°ê³¼ë¥¼ ìœ„í•´ <strong>60ë¬¸í•­</strong>ìœ¼ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤<br>
  - ê²°ê³¼ëŠ” <strong>3ì¼ê°„ ë³´ê´€</strong>ë˜ë©° ìë™ ì‚­ì œë©ë‹ˆë‹¤<br>
  - ê¸°ì¡´ ê²€ì‚¬ìëŠ” <strong>ì´ë¦„ ê²€ìƒ‰</strong>ìœ¼ë¡œ ê²°ê³¼ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.
</div>

<!-- ê²½ê³  ë©”ì‹œì§€ ë°•ìŠ¤ -->
<div id="warningBox" class="warning"><span id="warningText"></span></div>

<!-- ì´ë¦„ ì…ë ¥ -->
<p>
  ì´ë¦„: <input type="text" id="nameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
  <button onclick="searchPrevious()">ê²€ìƒ‰</button>
</p>

<div id="searchResponse"></div>
<div id="loadingBox" class="loading" style="display:none;">â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<!-- ë¬¸í•­ ì¶œë ¥ í¼ -->
<form id="questionForm"></form>

<!-- ê²°ê³¼ë³´ê¸° ë²„íŠ¼ -->
<button class="btn-submit" onclick="submitAnswers()">ê²°ê³¼ ë³´ê¸°</button>

<!-- ë¬¸í•­ ê²½ê³  -->
<div id="questionWarningBox" class="warning" style="display:none;">
  <span id="questionWarningText"></span>
</div>

<!-- ê²°ê³¼ ë³´ê³ ì„œ ì˜ì—­ -->
<div class="result-box" id="resultSection" style="display:none">
  <h3>ê²°ê³¼ ë³´ê³ ì„œ</h3>
  <table id="resultTable" border="1" style="width:100%; border-collapse:collapse;"></table>
  <br>
  <div style="text-align: left; margin-bottom: 10px;">
    <label for="chartType" style="font-size: 18px; margin-right: 10px;">ê·¸ë˜í”„ ì„ íƒ:</label>
    <select id="chartType" onchange="changeChartType()" style="font-size: 18px; padding: 5px 10px;">
      <option value="radar">ë‹¤ê°í˜•(ë ˆì´ë”ì°¨íŠ¸)</option>
      <option value="bar">ë§‰ëŒ€ê·¸ë˜í”„</option>
    </select>
  </div>
  <div style="position: relative; width: 80%; margin: auto;">
    <canvas id="radarChart" style="width:100%; height:260px; background-color:white; display:block;"></canvas>
    <canvas id="barChart"   style="width:100%; height:260px; background-color:white; display:none;"></canvas>
  </div>
  <br><br>
  <button onclick="location.reload()">ğŸ” ë‚˜ê°€ê¸°</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase Functions ì—”ë“œí¬ì¸íŠ¸ (ë°°í¬ í›„ ìë™ ìƒì„±ëœ URLë¡œ êµì²´)
// í˜•ì‹: https://us-central1-values-test-31b59.cloudfunctions.net/í•¨ìˆ˜ëª…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BASE_URL = "https://us-central1-values-test-31b59.cloudfunctions.net";

let questions = [], answers = {}, lastSearchResult = null, currentUserName = "";
let radarChartObj = null, barChartObj = null;

// â”€â”€ API í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiPost(endpoint, body = {}) {
  const res = await fetch(`${BASE_URL}/${endpoint}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(`API ì˜¤ë¥˜: ${res.status}`);
  return res.json();
}

// â”€â”€ í˜ì´ì§€ ë¡œë“œ ì‹œ ë¬¸í•­ ë¶ˆëŸ¬ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = async () => {
  showLoading(true);
  try {
    const data = await fetch(`${BASE_URL}/getQuestions`, { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}" }).then(r => r.json());
    renderQuestions(data.questions || []);
  } catch (e) {
    showWarning("ë¬¸í•­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + e.message);
  } finally {
    showLoading(false);
  }
};

// â”€â”€ ì´ë¦„ ê²€ìƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function searchPrevious() {
  const name = document.getElementById("nameInput").value.trim();
  if (!name) return showWarning("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  currentUserName = name;

  showLoading(true);
  try {
    const data = await apiPost("getUserResult", { name });
    lastSearchResult = data.found ? data.result : null;
    const box = document.getElementById("searchResponse");

    if (data.found) {
      box.innerHTML = `
        <div class='confirm-box'>
          ì´ì „ì— ê²€ì‚¬ë¥¼ í–ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?<br>
          <button onclick='confirmLoadResult(true)'>ì˜ˆ</button>
          <button onclick='confirmLoadResult(false)'>ì•„ë‹ˆì˜¤</button>
        </div>`;
    } else {
      box.innerHTML = `
        <div class='confirm-box'>
          ê²€ì‚¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
          <button onclick='confirmLoadResult(true, true)'>ì˜ˆ</button>
          <button onclick='confirmLoadResult(false)'>ì•„ë‹ˆì˜¤</button>
        </div>`;
    }
  } catch (e) {
    showWarning("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: " + e.message);
  } finally {
    showLoading(false);
  }
}

// â”€â”€ ê²€ìƒ‰ ê²°ê³¼ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmLoadResult(ok, isNew = false) {
  const responseBox = document.getElementById("searchResponse");
  if (ok && lastSearchResult) {
    responseBox.innerHTML = "";
    renderResult(lastSearchResult);
    document.getElementById("resultSection").scrollIntoView({ behavior: 'smooth' });
  } else if (ok && isNew) {
    responseBox.innerHTML = "";
    document.getElementById("warningBox").style.display = "none";
  } else {
    location.reload();
  }
}

// â”€â”€ ë¬¸í•­ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQuestions(data) {
  questions = data;
  const form = document.getElementById("questionForm");
  form.innerHTML = "";
  data.forEach((q, i) => {
    const div = document.createElement("div");
    div.className = "question";
    let html = `<p>${i + 1}. ${q.text}</p>`;
    for (let j = 1; j <= 5; j++) {
      const label = q[`select${j}`];
      const score = q[`score${j}`];
      if (!label) continue;
      html += `<button type='button' class='btn-choice' onclick='selectAnswer("${q.id}", ${score}, this)'>${label}</button>`;
    }
    div.innerHTML = html;
    form.appendChild(div);
  });
}

// â”€â”€ ë‹µë³€ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectAnswer(qid, score, btn) {
  answers[qid] = score;
  const group = btn.parentElement.querySelectorAll(".btn-choice");
  group.forEach(b => b.classList.remove("selected"));
  btn.classList.add("selected");
}

// â”€â”€ ë‹µë³€ ì œì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitAnswers() {
  const name = document.getElementById("nameInput").value.trim();
  if (!name) return showWarning("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  currentUserName = name;

  const unanswered = questions.filter(q => answers[q.id] === undefined);
  if (unanswered.length) {
    const missing = unanswered.map(q => q.id).join(", ");
    showWarning(`ë‹¤ìŒ ë¬¸í•­ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: ${missing}. ë¬¸í•­ì„ ëª¨ë‘ ì…ë ¥í•´ì•¼ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    return;
  }

  document.getElementById("questionWarningBox").style.display = "none";
  showLoading(true);

  try {
    const data = await apiPost("saveAnswers", { name, answers });
    renderResult(data.result);
    setTimeout(() => {
      document.getElementById("resultSection").scrollIntoView({ behavior: 'smooth' });
    }, 300);
  } catch (e) {
    showWarning("ì œì¶œ ì¤‘ ì˜¤ë¥˜: " + e.message);
  } finally {
    showLoading(false);
  }
}

// â”€â”€ ê²½ê³  í‘œì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showWarning(msg) {
  const box = document.getElementById("warningBox");
  document.getElementById("warningText").textContent = msg;
  box.style.display = "block";
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function showLoading(show) {
  document.getElementById("loadingBox").style.display = show ? "block" : "none";
}

// â”€â”€ ê²°ê³¼ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResult(result) {
  if (!result || !Array.isArray(result)) return showWarning("ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
  document.getElementById("resultSection").style.display = "block";
  const table = document.getElementById("resultTable");

  let html = `
    <tr>
      <th style="width:7%;  text-align:center;">ê°€ì¹˜ìœ í˜•</th>
      <th style="width:5%;  text-align:center;">ì ìˆ˜</th>
      <th style="width:22%; text-align:center;">í‰ê°€</th>
      <th style="width:22%;">ìê¸°ê°œë°œ íŒ</th>
      <th style="width:22%;">ì„±ì¥ íŒ</th>
      <th style="width:22%;">ê°•ì /ì•½ì </th>
    </tr>`;

  const labels = [], scores = [];
  result.forEach(row => {
    html += `
      <tr>
        <td style="text-align:center;">${row.ê°€ì¹˜ìœ í˜•}</td>
        <td style="text-align:center;">${row.ì ìˆ˜}</td>
        <td>${row.í‰ê°€}</td>
        <td>${row.ìê¸°ê°œë°œíŒ}</td>
        <td>${row.ì„±ì¥íŒ}</td>
        <td>${row.ê°•ì } / ${row.ì•½ì }</td>
      </tr>`;
    labels.push(row.ê°€ì¹˜ìœ í˜•);
    scores.push(row.ì ìˆ˜);
  });

  table.innerHTML = html;
  drawRadar(labels, scores);
  drawBar(labels, scores);
}

// â”€â”€ ë ˆì´ë” ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawRadar(labels, scores) {
  if (radarChartObj) radarChartObj.destroy();
  const ctx = document.getElementById("radarChart").getContext("2d");
  radarChartObj = new Chart(ctx, {
    type: 'radar',
    data: {
      labels,
      datasets: [{
        label: "ê°€ì¹˜ ì ìˆ˜",
        data: scores,
        backgroundColor: "rgba(54, 162, 235, 0.2)",
        borderColor: "rgba(54, 162, 235, 1)",
        borderWidth: 3,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      layout: { padding: 5 },
      scales: {
        r: {
          min: 0, max: 30,
          ticks: { stepSize: 5 },
          pointLabels: { font: { size: 16 } }
        }
      }
    }
  });
}

// â”€â”€ ë§‰ëŒ€ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBar(labels, scores) {
  if (barChartObj) barChartObj.destroy();
  const ctx = document.getElementById("barChart").getContext("2d");
  barChartObj = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: "ê°€ì¹˜ ì ìˆ˜",
        data: scores,
        backgroundColor: "rgba(75, 192, 192, 0.5)",
        borderColor: "rgba(75, 192, 192, 1)",
        borderWidth: 1,
        barThickness: 25
      }]
    },
    options: {
      responsive: true,
      layout: { padding: 40 },
      scales: {
        y: { beginAtZero: true, max: 30, ticks: { stepSize: 5 } }
      }
    }
  });
}

// â”€â”€ ê·¸ë˜í”„ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function changeChartType() {
  const type = document.getElementById("chartType").value;
  document.getElementById("radarChart").style.display = (type === "radar") ? "block" : "none";
  document.getElementById("barChart").style.display   = (type === "bar")   ? "block" : "none";
}
</script>
</body>
</html>
