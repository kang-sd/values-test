<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AXIA Â· ê°€ì¹˜ê´€ ë¶„ì„</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Noto+Serif+KR:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg:      #f9f6f1;
      --surface: #ffffff;
      --ink:     #1c1712;
      --ink2:    #4e4840;
      --teal:    #2e7d6e;
      --teal2:   #4aad98;
      --teal-bg: #eef8f6;
      --border:  #e4ddd4;
      --accent:  #1a5c52;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--ink); font-family: 'Noto Serif KR', serif; min-height: 100vh; }

    .top-bar { height: 4px; background: linear-gradient(90deg, var(--teal), var(--teal2), var(--teal)); }
    .container { max-width: 780px; margin: 0 auto; padding: 0 24px 80px; }

    /* í—¤ë” */
    .header { text-align: center; padding: 52px 0 44px; animation: fadeDown 0.8s ease both; }
    .header-eyebrow { font-size: 10px; letter-spacing: 5px; text-transform: uppercase; color: var(--teal); margin-bottom: 18px; }
    .header h1 { font-family: 'Cormorant Garamond', serif; font-size: clamp(48px, 10vw, 84px); font-weight: 300; font-style: italic; color: var(--ink); line-height: 0.95; letter-spacing: -2px; }
    .header h1 span { color: var(--teal); }
    .header-rule { width: 50px; height: 1px; background: linear-gradient(90deg, transparent, var(--teal), transparent); margin: 22px auto 18px; }
    .header-sub { font-size: 13px; color: var(--ink2); }

    /* ì•ˆë‚´ ì¹´ë“œ */
    .intro-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); margin-bottom: 44px; animation: fadeUp 0.8s 0.2s ease both; }
    .intro-card { background: var(--surface); padding: 24px 18px; text-align: center; }
    .intro-card-num { font-family: 'Cormorant Garamond', serif; font-size: 38px; font-weight: 300; color: var(--teal); line-height: 1; margin-bottom: 6px; }
    .intro-card-title { font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--teal); margin-bottom: 8px; }
    .intro-card p { font-size: 12px; color: var(--ink2); line-height: 1.6; }

    /* ì´ë¦„ ì…ë ¥ */
    .name-section { margin-bottom: 36px; animation: fadeUp 0.8s 0.3s ease both; }
    .section-label { font-size: 10px; letter-spacing: 4px; text-transform: uppercase; color: var(--teal); margin-bottom: 10px; }
    .name-row { display: flex; gap: 10px; }
    .name-input { flex: 1; background: var(--surface); border: 1px solid var(--border); color: var(--ink); font-family: 'Noto Serif KR', serif; font-size: 16px; padding: 14px 18px; outline: none; transition: border-color 0.25s; }
    .name-input:focus { border-color: var(--teal); }
    .name-input::placeholder { color: #bbb; }
    .btn-search { background: var(--surface); border: 1px solid var(--teal); color: var(--teal); font-family: 'Cormorant Garamond', serif; font-size: 15px; letter-spacing: 2px; padding: 14px 26px; cursor: pointer; transition: all 0.25s; white-space: nowrap; }
    .btn-search:hover { background: var(--teal); color: #fff; }

    /* í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ */
    .confirm-box { background: var(--teal-bg); border: 1px solid rgba(46,125,110,0.3); padding: 22px 24px; margin-bottom: 28px; animation: fadeUp 0.3s ease; }
    .confirm-box p { font-size: 15px; color: var(--ink); margin-bottom: 16px; line-height: 1.7; }
    .confirm-btns { display: flex; gap: 10px; }
    .btn-yes { background: var(--teal); border: none; color: #fff; font-family: 'Noto Serif KR', serif; font-size: 14px; padding: 11px 26px; cursor: pointer; transition: opacity 0.2s; }
    .btn-yes:hover { opacity: 0.85; }
    .btn-no  { background: transparent; border: 1px solid var(--border); color: var(--ink2); font-family: 'Noto Serif KR', serif; font-size: 14px; padding: 11px 26px; cursor: pointer; transition: all 0.2s; }
    .btn-no:hover { border-color: var(--ink2); color: var(--ink); }

    /* ì§„í–‰ ë°” */
    .progress-wrap { position: sticky; top: 0; z-index: 10; background: var(--bg); padding: 10px 0 14px; border-bottom: 1px solid var(--border); margin-bottom: 8px; display: none; }
    .progress-bar-bg { height: 2px; background: var(--border); position: relative; }
    .progress-bar-fill { position: absolute; inset: 0; background: linear-gradient(90deg, var(--teal), var(--teal2)); transform-origin: left; transform: scaleX(0); transition: transform 0.3s ease; }
    .progress-text { font-size: 11px; letter-spacing: 1px; color: var(--ink2); text-align: right; margin-top: 6px; }

    /* ë¬¸í•­ êµ¬ë¶„ì„  */
    .questions-header { display: none; align-items: center; gap: 18px; margin-bottom: 8px; }
    .questions-header-line { flex: 1; height: 1px; background: var(--border); }
    .questions-header-text { font-size: 10px; letter-spacing: 4px; text-transform: uppercase; color: var(--teal); }

    /* ë¬¸í•­ */
    #valuesForm { animation: fadeUp 0.8s 0.4s ease both; }
    .question { border-bottom: 1px solid var(--border); padding: 24px 0; }
    .question:last-child { border-bottom: none; }
    .q-meta { display: flex; align-items: baseline; gap: 12px; margin-bottom: 14px; }
    .q-num { font-family: 'Cormorant Garamond', serif; font-size: 13px; color: var(--teal); min-width: 28px; opacity: 0.6; }
    .q-text { font-size: 15px; color: var(--ink); line-height: 1.65; }
    .q-choices { display: flex; gap: 10px; padding-left: 40px; flex-wrap: wrap; }
    .btn-choice { background: var(--surface); border: 1px solid var(--border); color: var(--ink2); font-family: 'Noto Serif KR', serif; font-size: 14px; padding: 11px 22px; cursor: pointer; transition: all 0.2s; }
    .btn-choice:hover { border-color: var(--teal2); color: var(--ink); background: var(--teal-bg); }
    .btn-choice.selected { background: var(--teal); border-color: var(--teal); color: #fff; font-weight: 600; }

    /* ê²½ê³  */
    .warning-bar { background: #fff5f5; border-left: 3px solid #e05252; color: #b83232; padding: 12px 18px; font-size: 13px; margin: 12px 0; display: none; line-height: 1.6; }

    /* ì œì¶œ ë²„íŠ¼ */
    .submit-wrap { padding: 40px 0 0; text-align: center; }
    .btn-submit { background: var(--teal); border: none; color: #fff; font-family: 'Cormorant Garamond', serif; font-size: 18px; letter-spacing: 3px; padding: 18px 60px; cursor: pointer; width: 100%; max-width: 380px; transition: background 0.25s, transform 0.15s; }
    .btn-submit:hover { background: var(--accent); transform: translateY(-1px); }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* ìŠ¤í”¼ë„ˆ */
    #spinner { display: none; text-align: center; padding: 60px 0; }
    .spinner-ring { width: 44px; height: 44px; border: 2px solid var(--border); border-top-color: var(--teal); border-radius: 50%; animation: spin 0.9s linear infinite; margin: 0 auto 14px; }
    .spinner-text { font-size: 12px; letter-spacing: 2px; color: var(--ink2); text-transform: uppercase; }

    /* â•â• ê²°ê³¼ ì„¹ì…˜ â•â• */
    #resultSection { display: none; animation: fadeUp 0.7s ease both; }
    .result-header { text-align: center; padding: 56px 0 44px; border-bottom: 1px solid var(--border); margin-bottom: 44px; }
    .result-eyebrow { font-size: 10px; letter-spacing: 5px; text-transform: uppercase; color: var(--teal); margin-bottom: 22px; }
    .result-top3 { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin-bottom: 28px; }
    .top3-badge { text-align: center; }
    .top3-rank { font-family: 'Cormorant Garamond', serif; font-size: 11px; color: var(--teal); opacity: 0.7; margin-bottom: 6px; letter-spacing: 2px; }
    .top3-name { font-family: 'Cormorant Garamond', serif; font-size: clamp(22px,5vw,36px); font-weight: 300; color: var(--ink); }
    .top3-name.rank1 { font-size: clamp(32px,8vw,56px); color: var(--teal); font-style: italic; }
    .top3-score { font-size: 11px; color: var(--ink2); margin-top: 4px; letter-spacing: 1px; }
    .result-divider { width: 1px; height: 60px; background: var(--border); margin: auto 8px; }
    .result-subtitle { font-size: 13px; color: var(--ink2); font-style: italic; line-height: 1.8; }

    /* ì°¨íŠ¸ */
    .chart-section { background: var(--surface); border: 1px solid var(--border); padding: 28px 28px 24px; margin-bottom: 40px; }
    .chart-title { font-size: 10px; letter-spacing: 4px; text-transform: uppercase; color: var(--teal); margin-bottom: 16px; text-align: center; }
    .chart-tabs { display: flex; margin-bottom: 20px; border: 1px solid var(--border); }
    .chart-tab { flex: 1; padding: 9px; font-size: 12px; letter-spacing: 1px; text-align: center; cursor: pointer; font-family: 'Noto Serif KR', serif; color: var(--ink2); background: var(--surface); border: none; transition: all 0.2s; }
    .chart-tab.active { background: var(--teal); color: #fff; }

    /* ì ìˆ˜ ìƒì„¸ í…Œì´ë¸” */
    .score-table-wrap { margin-bottom: 40px; border: 1px solid var(--border); background: var(--surface); overflow: hidden; }
    .score-table-title { font-size: 10px; letter-spacing: 4px; text-transform: uppercase; color: var(--teal); padding: 16px 20px 12px; border-bottom: 1px solid var(--border); background: var(--teal-bg); }
    .score-row { display: grid; grid-template-columns: 110px 1fr 60px; align-items: center; gap: 16px; padding: 12px 20px; border-bottom: 1px solid var(--border); }
    .score-row:last-child { border-bottom: none; }
    .score-row.rank1 { background: rgba(46,125,110,0.05); }
    .score-row.rank1 .score-type { color: var(--teal); font-weight: 600; }
    .score-type { font-size: 14px; color: var(--ink2); }
    .score-bar-bg { height: 4px; background: var(--border); border-radius: 2px; position: relative; overflow: hidden; }
    .score-bar-fill { position: absolute; left: 0; top: 0; height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--teal), var(--teal2)); transition: width 1s ease; }
    .score-val { font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--ink); text-align: right; }
    .score-val.rank1 { color: var(--teal); }

    /* ê²°ê³¼ ìƒì„¸ */
    .result-fields { border: 1px solid var(--border); margin-bottom: 40px; background: var(--surface); }
    .field-section-title { font-size: 10px; letter-spacing: 4px; text-transform: uppercase; color: var(--teal); padding: 16px 20px 12px; border-bottom: 1px solid var(--border); background: var(--teal-bg); }
    .field-row { display: grid; grid-template-columns: 130px 1fr; border-bottom: 1px solid var(--border); }
    .field-row:last-child { border-bottom: none; }
    .field-key { padding: 16px 16px 16px 20px; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--teal); background: var(--teal-bg); border-right: 1px solid var(--border); display: flex; align-items: flex-start; padding-top: 18px; line-height: 1.6; }
    .field-val { padding: 16px 20px; font-size: 14px; color: var(--ink2); line-height: 1.85; }

    /* ë²„íŠ¼ */
    .result-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .btn-print { background: var(--teal); border: none; color: #fff; font-family: 'Noto Serif KR', serif; font-size: 15px; padding: 16px 36px; cursor: pointer; transition: background 0.2s, transform 0.15s; display: flex; align-items: center; gap: 8px; }
    .btn-print:hover { background: var(--accent); transform: translateY(-1px); }
    .btn-restart { background: var(--surface); border: 1px solid var(--border); color: var(--ink2); font-family: 'Noto Serif KR', serif; font-size: 15px; padding: 16px 36px; cursor: pointer; transition: all 0.2s; }
    .btn-restart:hover { border-color: var(--ink); color: var(--ink); }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fadeDown { from { opacity:0; transform:translateY(-16px); } to { opacity:1; transform:translateY(0); } }
    @keyframes fadeUp   { from { opacity:0; transform:translateY(16px);  } to { opacity:1; transform:translateY(0); } }
    @keyframes spin     { to { transform: rotate(360deg); } }

    /* ì¸ì‡„ */
    @media print {
      .top-bar,.header,.intro-cards,.name-section,
      .progress-wrap,.questions-header,#valuesForm,
      .warning-bar,.submit-wrap,#spinner,
      #searchResponse,#searchWarningBox,#answerWarningBox,
      .result-actions,.chart-tabs { display: none !important; }
      body { background:#fff !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      .container { max-width:100%; padding:0 16px; }
      #resultSection { display:block !important; }
      .print-only-header { display:flex !important; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:2px solid #2e7d6e; margin-bottom:0; }
      .print-only-header .brand { font-family:'Cormorant Garamond',serif; font-size:18pt; font-style:italic; color:#2e7d6e; }
      .print-only-header .print-date { font-size:9pt; color:#888; }
      .score-bar-fill { -webkit-print-color-adjust:exact; }
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 600px) {
      .intro-cards { grid-template-columns: repeat(2,1fr); }
      .q-choices { padding-left:0; flex-direction:column; }
      .btn-choice { width:100%; }
      .field-row { grid-template-columns:1fr; }
      .field-key { border-right:none; border-bottom:1px solid var(--border); }
      .result-divider { display:none; }
      .score-row { grid-template-columns: 90px 1fr 50px; gap:10px; }
    }
  </style>
</head>
<body>

<div class="top-bar"></div>
<div class="container">

  <div class="print-only-header" style="display:none;">
    <div class="brand">Axia Â· ê°€ì¹˜ê´€ë¶„ì„</div>
    <div class="print-date" id="printDate"></div>
  </div>

  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-eyebrow">ì§ì—… ê°€ì¹˜ê´€ ì •ë°€ ë¶„ì„</div>
    <h1>Ax<span>ia</span></h1>
    <div class="header-rule"></div>
    <div class="header-sub">ë‹¹ì‹ ì´ ì¼ì—ì„œ ì§„ì •ìœ¼ë¡œ ì›í•˜ëŠ” ê²ƒì„ ë°œê²¬í•˜ë‹¤</div>
  </div>

  <!-- ì•ˆë‚´ ì¹´ë“œ -->
  <div class="intro-cards">
    <div class="intro-card">
      <div class="intro-card-num">60</div>
      <div class="intro-card-title">ë¬¸í•­ êµ¬ì„±</div>
      <p>ì •ë°€í•œ ê²°ê³¼ë¥¼ ìœ„í•´<br>ì„¤ê³„ëœ 60ê°œ ë¬¸í•­</p>
    </div>
    <div class="intro-card">
      <div class="intro-card-num">12</div>
      <div class="intro-card-title">ê°€ì¹˜ ìœ í˜•</div>
      <p>ì§ì—… ê°€ì¹˜ìœ í˜•ë³„<br>ì‹¬ì¸µ ë¶„ì„ ë° ì¡°ì–¸</p>
    </div>
    <div class="intro-card">
      <div class="intro-card-num">3</div>
      <div class="intro-card-title">ì¼ ë³´ê´€</div>
      <p>ì´ë¦„ ê²€ìƒ‰ìœ¼ë¡œ<br>3ì¼ ì´ë‚´ ì¬í™•ì¸ ê°€ëŠ¥</p>
    </div>
    <div class="intro-card">
      <div class="intro-card-num">âˆ</div>
      <div class="intro-card-title">ì‹œê°í™”</div>
      <p>12ê°€ì§€ ì ìˆ˜ë¥¼<br>ê·¸ë˜í”„ë¡œ í•œëˆˆì—</p>
    </div>
  </div>

  <!-- ì´ë¦„ ì…ë ¥ -->
  <div class="name-section">
    <div class="section-label">ì´ë¦„ ì…ë ¥</div>
    <div class="name-row">
      <input class="name-input" type="text" id="nameInput" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
      <button class="btn-search" onclick="searchPrevious()">ê²€ìƒ‰</button>
    </div>
  </div>

  <div class="warning-bar" id="searchWarningBox"></div>
  <div id="searchResponse"></div>

  <!-- ìŠ¤í”¼ë„ˆ -->
  <div id="spinner">
    <div class="spinner-ring"></div>
    <div class="spinner-text">ë¬¸í•­ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
  </div>

  <!-- ì§„í–‰ ë°” -->
  <div class="progress-wrap" id="progressWrap">
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText">0 / 60</div>
  </div>

  <!-- ë¬¸í•­ êµ¬ë¶„ì„  -->
  <div class="questions-header" id="questionsHeader">
    <div class="questions-header-line"></div>
    <div class="questions-header-text">ê²€ì‚¬ ë¬¸í•­</div>
    <div class="questions-header-line"></div>
  </div>

  <!-- ë¬¸í•­ í¼ -->
  <form id="valuesForm"></form>

  <div class="warning-bar" id="answerWarningBox"></div>

  <div class="submit-wrap" id="submitWrap">
    <button class="btn-submit" id="submitBtn" onclick="submitAnswers()">ê²°ê³¼ ë³´ê¸°</button>
  </div>

  <!-- â•â• ê²°ê³¼ ì„¹ì…˜ â•â• -->
  <div id="resultSection">

    <div class="result-header">
      <div class="result-eyebrow">ë‹¹ì‹ ì˜ ì§ì—… ê°€ì¹˜ê´€ í”„ë¡œí•„</div>
      <div class="result-top3" id="top3Display"></div>
      <div class="result-subtitle" id="resultSubtitle"></div>
    </div>

    <!-- ì°¨íŠ¸ -->
    <div class="chart-section">
      <div class="chart-title">ê°€ì¹˜ìœ í˜•ë³„ ì ìˆ˜ ë¹„êµ</div>
      <div class="chart-tabs">
        <button class="chart-tab active" onclick="switchChart('radar',this)">ë ˆì´ë” ì°¨íŠ¸</button>
        <button class="chart-tab" onclick="switchChart('bar',this)">ë§‰ëŒ€ ê·¸ë˜í”„</button>
      </div>
      <canvas id="valuesChart"></canvas>
    </div>

    <!-- ì ìˆ˜ ìƒì„¸ -->
    <div class="score-table-wrap">
      <div class="score-table-title">ì „ì²´ ê°€ì¹˜ìœ í˜• ì ìˆ˜</div>
      <div id="scoreRows"></div>
    </div>

    <!-- ìƒì„¸ ì„¤ëª… (TOP3) -->
    <div class="result-fields" id="resultFields"></div>

    <div class="result-actions">
      <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„ / PDF ì €ì¥</button>
      <button class="btn-restart" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

  </div>
</div>

<script>
const BASE_URL = "https://us-central1-values-test-31b59.cloudfunctions.net";
let questionData = [], answers = {}, lastSearchResult = null, chartInst = null, currentChartType = "radar";

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(endpoint, body = {}) {
  const r = await fetch(`${BASE_URL}/${endpoint}`, {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const d = await r.json();
  if (!r.ok) throw new Error(d.error || "ì„œë²„ ì˜¤ë¥˜");
  return d;
}

function showWarning(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg; el.style.display = "block";
  if (id === "searchWarningBox") setTimeout(() => el.style.display = "none", 4000);
}

// â”€â”€ ìŠ¤í”¼ë„ˆ / í¼ í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSpinner(on) {
  document.getElementById("spinner").style.display = on ? "block" : "none";
  document.getElementById("valuesForm").style.display = on ? "none" : "block";
  document.getElementById("submitWrap").style.display = on ? "none" : "block";
  if (!on) {
    document.getElementById("progressWrap").style.display    = "block";
    document.getElementById("questionsHeader").style.display = "flex";
  }
}

// â”€â”€ ì§„í–‰ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateProgress() {
  const done = Object.keys(answers).length;
  const total = questionData.length || 60;
  document.getElementById("progressFill").style.transform = `scaleX(${done / total})`;
  document.getElementById("progressText").textContent = `${done} / ${total}`;
}

// â”€â”€ í˜ì´ì§€ ë¡œë“œ â†’ ë¬¸í•­ ë¶ˆëŸ¬ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = async () => {
  // ë¡œë”© ì¤‘: ìŠ¤í”¼ë„ˆ í‘œì‹œ, í¼ ìˆ¨ê¹€
  document.getElementById("spinner").style.display    = "block";
  document.getElementById("valuesForm").style.display = "none";
  document.getElementById("submitWrap").style.display = "none";
  try {
    const data = await api("getQuestions", {});
    renderQuestions(data.questions || []);
  } catch (e) {
    alert("ë¬¸í•­ ë¡œë“œ ì‹¤íŒ¨: " + e.message);
  } finally {
    // ë¡œë”© ì™„ë£Œ: ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€, ë¬¸í•­Â·ì§„í–‰ë°”Â·ë²„íŠ¼ í‘œì‹œ
    document.getElementById("spinner").style.display         = "none";
    document.getElementById("valuesForm").style.display      = "block";
    document.getElementById("submitWrap").style.display      = "block";
    document.getElementById("progressWrap").style.display    = "block";
    document.getElementById("questionsHeader").style.display = "flex";
  }
};

// â”€â”€ ë¬¸í•­ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQuestions(data) {
  questionData = data;
  const form = document.getElementById("valuesForm");
  form.innerHTML = "";
  data.forEach((q, i) => {
    const div = document.createElement("div");
    div.className = "question";
    let choicesHtml = "";
    for (let j = 1; j <= 5; j++) {
      const label = q[`select${j}`];
      const score = q[`score${j}`];
      if (!label) continue;
      choicesHtml += `<button type="button" class="btn-choice" onclick="selectAnswer('${q.id}',${score},this)">${label}</button>`;
    }
    div.innerHTML = `
      <div class="q-meta">
        <div class="q-num">${String(i+1).padStart(2,"0")}</div>
        <div class="q-text">${q.text}</div>
      </div>
      <div class="q-choices">${choicesHtml}</div>`;
    form.appendChild(div);
  });
}

// â”€â”€ ë‹µë³€ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectAnswer(qid, score, btn) {
  answers[qid] = score;
  btn.closest(".q-choices").querySelectorAll(".btn-choice").forEach(b => b.classList.remove("selected"));
  btn.classList.add("selected");
  updateProgress();
}

// â”€â”€ ì´ë¦„ ê²€ìƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function searchPrevious() {
  const name = document.getElementById("nameInput").value.trim();
  if (!name) return showWarning("searchWarningBox", "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  const box = document.getElementById("searchResponse");
  box.innerHTML = `<div style="font-size:13px;color:var(--ink2);padding:10px 0;">ê²€ìƒ‰ ì¤‘â€¦</div>`;
  try {
    const data = await api("getUserResult", { name });
    lastSearchResult = data.found ? data.result : null;
    if (data.found) {
      box.innerHTML = `<div class="confirm-box">
        <p>ì´ì „ ê²€ì‚¬ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ ë°”ë¡œ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div class="confirm-btns">
          <button class="btn-yes" onclick="confirmLoad(true)">ì˜ˆ, ê²°ê³¼ ë³´ê¸°</button>
          <button class="btn-no"  onclick="confirmLoad(false)">ìƒˆë¡œ ê²€ì‚¬í•˜ê¸°</button>
        </div></div>`;
    } else {
      box.innerHTML = `<div class="confirm-box">
        <p>ê¸°ì¡´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì§€ê¸ˆ ë°”ë¡œ ê²€ì‚¬ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div class="confirm-btns">
          <button class="btn-yes" onclick="confirmLoad(true,true)">ì˜ˆ, ì‹œì‘í•˜ê¸°</button>
          <button class="btn-no"  onclick="confirmLoad(false)">ì·¨ì†Œ</button>
        </div></div>`;
    }
  } catch(e) {
    box.innerHTML = `<div style="color:#e05252;font-size:13px;padding:10px 0;">ì˜¤ë¥˜: ${e.message}</div>`;
  }
}

// â”€â”€ ê²€ìƒ‰ ê²°ê³¼ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmLoad(ok, isNew = false) {
  document.getElementById("searchResponse").innerHTML = "";
  if (ok && lastSearchResult) renderResult(lastSearchResult);
  else if (!ok) location.reload();
  // isNew = true ì´ë©´ ê·¸ëƒ¥ ë‹«ê³  ê²€ì‚¬ ì§„í–‰
}

// â”€â”€ ë‹µë³€ ì œì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitAnswers() {
  const name = document.getElementById("nameInput").value.trim();
  if (!name) return showWarning("searchWarningBox", "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  const unanswered = questionData.filter(q => answers[q.id] === undefined);
  if (unanswered.length) {
    showWarning("answerWarningBox",
      `${unanswered.length}ê°œ ë¬¸í•­ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: ${unanswered.map(q=>q.id).join(", ")}`);
    return;
  }
  document.getElementById("answerWarningBox").style.display = "none";
  const btn = document.getElementById("submitBtn");
  btn.disabled = true; btn.textContent = "ë¶„ì„ ì¤‘â€¦";
  try {
    const data = await api("saveAnswers", { name, answers });
    renderResult(data.result);
  } catch(e) {
    alert("ì˜¤ë¥˜: " + e.message);
    btn.disabled = false; btn.textContent = "ê²°ê³¼ ë³´ê¸°";
  }
}

// â”€â”€ ê²°ê³¼ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResult(result) {
  if (!result || !Array.isArray(result)) { alert("ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

  // í¼ ì˜ì—­ ìˆ¨ê¸°ê¸°
  ["valuesForm","submitWrap","progressWrap","questionsHeader"].forEach(id => {
    document.getElementById(id).style.display = "none";
  });
  document.querySelector(".intro-cards").style.display = "none";
  document.querySelector(".name-section").style.display = "none";
  document.getElementById("searchResponse").innerHTML = "";

  // ì¸ì‡„ ë‚ ì§œ
  const now = new Date();
  document.getElementById("printDate").textContent =
    `${now.getFullYear()}. ${now.getMonth()+1}. ${now.getDate()} ì¶œë ¥`;

  // ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  const sorted = [...result].sort((a,b) => b.ì ìˆ˜ - a.ì ìˆ˜);
  const top3 = sorted.slice(0, 3);

  // TOP3 í‘œì‹œ
  const top3El = document.getElementById("top3Display");
  top3El.innerHTML = top3.map((item, i) => `
    ${i > 0 ? '<div class="result-divider"></div>' : ''}
    <div class="top3-badge">
      <div class="top3-rank">${["1st","2nd","3rd"][i]}</div>
      <div class="top3-name${i===0?' rank1':''}">${item.ê°€ì¹˜ìœ í˜•}</div>
      <div class="top3-score">${item.ì ìˆ˜}ì </div>
    </div>`).join("");

  document.getElementById("resultSubtitle").textContent =
    `${top3[0].ê°€ì¹˜ìœ í˜•} Â· ${top3[1].ê°€ì¹˜ìœ í˜•} Â· ${top3[2].ê°€ì¹˜ìœ í˜•}ì„ ì¤‘ì‹¬ìœ¼ë¡œ í•œ ì§ì—… ê°€ì¹˜ê´€ í”„ë¡œí•„`;

  // ì°¨íŠ¸
  drawChart(result, currentChartType);

  // ì ìˆ˜ ë°” í…Œì´ë¸”
  const scoreRowsEl = document.getElementById("scoreRows");
  scoreRowsEl.innerHTML = sorted.map((row, i) => `
    <div class="score-row${i===0?' rank1':''}">
      <div class="score-type">${i<3?['â‘ ','â‘¡','â‘¢'][i]+' ':''}${row.ê°€ì¹˜ìœ í˜•}</div>
      <div>
        <div class="score-bar-bg">
          <div class="score-bar-fill" style="width:${(row.ì ìˆ˜/30)*100}%"></div>
        </div>
      </div>
      <div class="score-val${i===0?' rank1':''}">${row.ì ìˆ˜}</div>
    </div>`).join("");

  // TOP3 ìƒì„¸ ì„¤ëª…
  const fieldsEl = document.getElementById("resultFields");
  fieldsEl.innerHTML = top3.map(row => `
    <div class="field-section-title">${row.ê°€ì¹˜ìœ í˜•} ìœ í˜• ìƒì„¸</div>
    <div class="field-row"><div class="field-key">í‰ê°€</div><div class="field-val">${row.í‰ê°€||"â€“"}</div></div>
    <div class="field-row"><div class="field-key">ìê¸°ê°œë°œ íŒ</div><div class="field-val">${row.ìê¸°ê°œë°œíŒ||"â€“"}</div></div>
    <div class="field-row"><div class="field-key">ì„±ì¥ íŒ</div><div class="field-val">${row.ì„±ì¥íŒ||"â€“"}</div></div>
    <div class="field-row"><div class="field-key">ê°•ì </div><div class="field-val">${row.ê°•ì ||"â€“"}</div></div>
    <div class="field-row"><div class="field-key">ì•½ì </div><div class="field-val">${row.ì•½ì ||"â€“"}</div></div>
  `).join("");

  document.getElementById("resultSection").style.display = "block";
  setTimeout(() => document.getElementById("resultSection").scrollIntoView({ behavior:"smooth" }), 100);
}

// â”€â”€ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawChart(result, type) {
  if (chartInst) { chartInst.destroy(); chartInst = null; }
  const sorted = [...result].sort((a,b) => b.ì ìˆ˜ - a.ì ìˆ˜);
  const labels = sorted.map(r => r.ê°€ì¹˜ìœ í˜•);
  const scores = sorted.map(r => r.ì ìˆ˜);
  const ctx = document.getElementById("valuesChart").getContext("2d");

  const commonDataset = {
    label: "ê°€ì¹˜ ì ìˆ˜",
    data: scores,
    backgroundColor: type === "radar"
      ? "rgba(46,125,110,0.18)"
      : scores.map((_,i) => i===0?"rgba(46,125,110,0.9)":i<3?"rgba(74,173,152,0.7)":"rgba(74,173,152,0.35)"),
    borderColor: type === "radar"
      ? "rgba(46,125,110,0.9)"
      : scores.map((_,i) => i<3?"rgba(46,125,110,1)":"rgba(46,125,110,0.5)"),
    borderWidth: type === "radar" ? 2 : 1,
    pointBackgroundColor: "rgba(46,125,110,1)",
    pointRadius: 3,
    barThickness: 22
  };

  const commonScaleStyle = {
    grid: { color: "rgba(0,0,0,0.05)" },
    ticks: { font: { family:"Noto Serif KR", size:12 }, color:"#4e4840" }
  };

  chartInst = new Chart(ctx, {
    type: type,
    data: { labels, datasets: [commonDataset] },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: { label: ctx => ` ${ctx.raw}ì ` },
          titleFont: { family:"Noto Serif KR" },
          bodyFont:  { family:"Noto Serif KR" }
        }
      },
      scales: type === "radar" ? {
        r: {
          min:0, max:30, ticks:{ stepSize:5, font:{family:"Noto Serif KR",size:10}, color:"#9a9088" },
          grid:{ color:"rgba(0,0,0,0.06)" },
          pointLabels:{ font:{family:"Noto Serif KR",size:12}, color:"#4e4840" }
        }
      } : {
        x: commonScaleStyle,
        y: { ...commonScaleStyle, beginAtZero:true, max:30, ticks:{...commonScaleStyle.ticks, stepSize:5} }
      }
    }
  });
}

function switchChart(type, btn) {
  document.querySelectorAll(".chart-tab").forEach(t => t.classList.remove("active"));
  btn.classList.add("active");
  currentChartType = type;
  // í˜„ì¬ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  const rows = document.querySelectorAll(".score-row");
  if (rows.length) {
    const scoreData = [...rows].map(row => ({
      ê°€ì¹˜ìœ í˜•: row.querySelector(".score-type").textContent.replace(/^[â‘ â‘¡â‘¢] /,""),
      ì ìˆ˜: parseInt(row.querySelector(".score-val").textContent)
    }));
    drawChart(scoreData, type);
  }
}
</script>
</body>

</html>
